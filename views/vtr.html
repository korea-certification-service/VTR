<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>Document</title>
<link href="/css/vtr.css" rel="stylesheet">
<script src="/socket.io/socket.io.js"></script>
<script src="/js/jquery.min.js"></script>
</head>
<body>
    <div class="chat_wrap" id="chatWrap">
        <header class="header">
            <h1 class="cf">
                <div class="vtr_category" id="vtrategory"><%=category%></div>
                <div class="vtr_title ellipse"><%=title%></div>
                <div class="vtr_price"><span id="vtrPriceNum"><%=price%></span> <%=cryptoCurrencyCode%></div>
            </h1>
        </header>
        <div class="content" id="content">
            <div>
                my Name <input type="text" id="nickname" readonly/><br>
                other Name <input type="text" id="othername" readonly/> 
            </div>
 
            <div class="chat_dim" id="chatDim"></div>
        </div>
        <footer class="footer cf">
            <div class="msg_sec cf">
                <button class="btn_at" id="btnAt"><img src="/img/ico_@.png" alt="@"></button>
                <input type="text" class="ipt_chat" id="iptChat" placeholder="메세지를 입력하세요.">
                <button class="btn_send" id="btnSend">Send</button>
            </div>
            <!-- <div class="util_sec cf">
                <button class="btn_sharp">#</button>
                <button class="btn_emoji">&#128513;</button>
            </div> -->
            <div class="at_sec" id="atSec">
                <div class="mach_command machCmd">@마하 거래안내</div>
                <div class="mach_command machCmd">@마하 거래요청</div>
                <div class="mach_command machCmd">@마하 구매확인</div>
                <div class="mach_command machCmd">@마하 판매완료</div>
                <div class="mach_command machCmd">@마하 거래완료</div>
                <div class="mach_command machCmd">@마하 거래취소</div>
            </div>
        </footer>
        <input type="hidden" id="room" value="<%=room%>" />
        <input type="hidden" id="userId" value="<%=userId%>" />
        <input type="hidden" id="buyerTag" value="<%=buyerTag%>" >
        <input type="hidden" id="sellerTag" value="<%=sellerTag%>" >
        <input type="hidden" id="country" value="<%=country%>" >
        <input type="hidden" id="tk" value="<%=token%>" >
        <input type="hidden" id="itemId" value="<%=itemId%>" >
        <input type="hidden" id="tradePrice" value="" >
        <input type="hidden" id="tradeStatus" value="" >
    </div>
<script>
// 로직 전부다 vanilla JS로 변경
// 완성 후 babel 써서 압축된 파일로 외부JS로 빼서 dist로 실행시키기(보안)
// 관리자 도구 여는거 막는 코드 추가(f12, 마우스 오른쪽, command+option+i)
var serverURL = 'http://localhost:4000';

//var socket = io.connect(serverURL, { transports: ['websocket'] }); // polling 사용 안함
var socket = io(serverURL, { transports: ['websocket'] }); // polling 사용 안함

var _room = document.getElementById("room").value;
var _userId = document.getElementById("userId").value;

// 방 입장
socket.emit('joinroom', { room: _room, userId: _userId, reconnect: false });

function fnScrollLast() {
    var bubble = document.querySelectorAll(".bubble");
    if(bubble.length > 1) {
        bubble[bubble.length-1].scrollIntoView(false);
        //var lastY = bubble[bubble.length-1].offsetTop;
        //document.querySelector(".content").scrollTo(0, lastY);
    }
}

function fnSendMsg() {
    var othername = document.getElementById("othername");
    var iptChat = document.getElementById("iptChat");
    var msgVal = iptChat.value;
    var originMsg = iptChat.value;
    var sendTxt = "";
    var arrComand = ["거래안내", "거래요청", "구매확인", "판매완료", "거래완료", "거래취소"];
    var isCommand = false;
    var regTradingTxt = /^@마하 /;
    var userId = document.getElementById("userId").value;
    var buyerTag = document.getElementById("buyerTag").value;
    var sellerTag = document.getElementById("sellerTag").value;

	var dom = '<div class="bubble mach_speech"><p>';
    var content = document.getElementById("content");

    if (regTradingTxt.test(msgVal)) {
        sendTxt = msgVal.replace('@마하 ', '');

        var i;
        for (i = 0; i < arrComand.length; i++) {
          if(arrComand[i] == sendTxt){
            isCommand = true;
            break;
          }
        }

        if(isCommand) { // 존재하는 명령어
			
            switch (i) {
                case 0:
                    dom += '거래 프로세스에 대해서 안내해드릴께요.<br>';
                    dom += '<img src="/img/VTR_info.png" alt="안내문"/>'              
                    content.insertAdjacentHTML("beforeend", dom);    
                    break;               
                default:
                    socket.emit("trade", { who: _userId, to: othername.value, msg: originMsg, command: i, buyerTag: buyerTag, sellerTag: sellerTag });
                    break;
            }

        } else { // 없는 명령어
            //socket.emit("trade", { who: _userId, to: othername.value, msg: originMsg, command: -1});
            dom += originMsg +" 명령어는 존재하지 않습니다. 다시 확인하시고 입력해주세요.";      
            dom += '</p></div>';
            content.insertAdjacentHTML("beforeend", dom);
        }

    } else {
        socket.emit('send_msg', { who: _userId, to: othername.value, msg: iptChat.value});
    }

    iptChat.value = '';
    //iptChat.focus();
    fnScrollLast(); // 스크롤 자동 최하단 이동
}

socket.on('new_user', function (data) {
    var p = document.createElement('p');
    document.getElementById("nickname").value = data.nickname;
    p.classList.add("p_system");
    p.innerText = data.yymmdd;
    document.getElementById("content").appendChild(p);
});

socket.on('userlist', function (data) {
    var userlist = data.users;
    var myname = document.getElementById("nickname").value;
    if(userlist.length > 1) {
        userlist.splice(userlist.indexOf(myname), 1);
        document.getElementById("othername").value = userlist[0];
    }
});

socket.on('broadcast_msg', function (data) {
    console.log('broadcast_msg', data);
    // 같은 유저 반복하지 않고 메세지 생성
    var txtChat = '';
    
    if(!data.sameUser){ // 같은 유저면 아이디 반복 표시 필요없음
        txtChat += '<em class="my_id">'+_userId+'</em>';
    }

    txtChat += '<div class="bubble my_speech"><p>' + data.msg;
    txtChat += '<span class="chat_time">' + data.msgtime + '</span></p></div>';

    var content = document.getElementById("content");
    content.insertAdjacentHTML("beforeend", txtChat);

    // 메세지에서 반복되는 시간 숨기기
    var my_speech = document.querySelectorAll('.my_speech');
    var len = my_speech.length;

    if(len > 1) { // 두번째 메세지 일때
        var chatTimeLast = my_speech[len-2].querySelector('.chat_time');
        console.log(chatTimeLast, len)
    
        if(data.sameUser && chatTimeLast.innerText === data.msgtime){
            //$chatTimeLast.css('display', 'none');
            chatTimeLast.style.display = 'none';
        }
        
        if(chatTimeLast.innerText !== data.msgtime) { // 같은 유저지만 시간이 다른경우 표시
            var em = '<em class="my_id">'+_userId+'</em>';
            my_speech[len-1].insertAdjacentHTML("beforebegin", em);
        }
    }
    
    fnScrollLast(); // 스크롤 자동 최하단 이동
});

socket.on('other_msg', function (data) {
    console.log("other_msg", data);
    // 같은 유저 반복하지 않고 메세지 생성
    var txtChat = '';
    
    if(!data.sameUser){ // 같은 유저면 아이디 반복 표시 필요없음
        txtChat += '<em class="other_id">'+ data.who +'</em>';
    }

    txtChat += '<div class="bubble other_speech"><p>' + data.msg;
    txtChat += '<span class="chat_time">' + data.msgtime + '</span></p></div>';

    var content = document.getElementById("content");
    content.insertAdjacentHTML("beforeend", txtChat);

    // 메세지에서 반복되는 시간 숨기기
    var my_speech = document.querySelectorAll('.other_speech');
    var len = my_speech.length;

    if(len > 1) { // 두번째 메세지 일때
        var chatTimeLast = my_speech[len-2].querySelector('.chat_time');
        console.log(chatTimeLast, len)
    
        if(data.sameUser && chatTimeLast.innerText === data.msgtime){
            //$chatTimeLast.css('display', 'none');
            chatTimeLast.style.display = 'none';
        }
        
        if(chatTimeLast.innerText !== data.msgtime) { // 같은 유저지만 시간이 다른경우 표시
            var em = '<em class="other_id">'+ data.who +'</em>';
            my_speech[len-1].insertAdjacentHTML("beforebegin", em);
        }
    }

    // 스크롤 자동 최하단 이동
    var bubble = document.querySelectorAll(".bubble");
    if(bubble.length > 1) {
        bubble[bubble.length-1].scrollIntoView(false);
        //var lastY = bubble[bubble.length-1].offsetTop;
        //document.querySelector(".content").scrollTo(0, lastY);
    }


    // chatbot, system
    if (data.who==="me") {

    } else { // 챗봇, 시스템, 상대방 3가지 who 더 필요

    }

});

// 시스템 메세지 
socket.on('system_msg', function (data) {
    //console.log('system_msg', data);
    var p = document.createElement('p');
    p.classList.add("p_system");
    p.innerText = data.msg;
    document.getElementById("content").appendChild(p);
});

// 로직 교체 후 지우기
socket.on('trade', function (data) {
	var dom = '<div class="bubble mach_speech"><p>';
    var content = document.getElementById("content");
    
    console.log('trade', data);

    if(data.type === "err") {
        dom += data.mymsg + "는 " + data.target + "가 실행할 수 없는 명령어 입니다.";
        dom += '<span class="chat_time">' + data.msgtime + '</span></p></div>';    
        dom += '</p></div>';
        content.insertAdjacentHTML("beforeend", dom);
    } else if(data.type === "other"){
		// 상대방 화면 돔생성
        switch (data.command) {
            case 0:
				// dom += '상대방이 거래안내를 보는 중입니다.<br>거래 안내를 보시려면 @마하 거래안내라고 입력해주세요.';              
				break;
            case 1:       
                dom += '판매자가 거래요청중입니다.<br>잠시만 기다려주세요.';      
                break;
			case 2:
				dom += '구매확인을 하시려면 아래 버튼을 눌러주세요.<span class="chat_time">' + data.msgtime + '</span>';
                dom += '<button id="btnPurchaseConfirmation" class="btn_chat btn_p_c">구매확인</button>';         
                break;
			case 3:
				//dom += '판매완료를 하시려면 아래 버튼을 눌러주세요.<span class="chat_time">' + data.msgtime + '</span>';
				//dom += '<button id="btnSalesComplete" class="btn_chat btn_s_c">판매 완료</button>';                
                break;
			case 4:
				//dom += '거래완료를 하시려면 아래 버튼을 눌러주세요.<span class="chat_time">' + data.msgtime + '</span>';
				//dom += '<button id="btnTransactionComplete" class="btn_chat btn_t_c">거래 완료</button>';                
                break;
            default:
                break;
        }

		dom += '</p></div>';
        content.insertAdjacentHTML("beforeend", dom);
	} else {
		// 내 화면에 돔생성
        switch (data.flagNum) {
            case 1:           
				dom += '상대방이 거래요청을 하였습니다.<br>거래 가격을 입력해주세요.<br><span class="chat_time">' + data.msgtime + '</span>';             
				dom += '<input type="text" id="iptPrice" class="ipt_price" placeholder="가격"><button id="btnTransactionRequest" class="btn_chat btn_t_r">거래요청</button>';                
                break;
            case 2:
				dom += '구매자의 구매 확인을 기다리는 중입니다.<br>잠시만 기다려주세요.';
                break;
            default:
                dom += data.mymsg;
                if(data.status === 0) {dom += '<img src="/img/VTR_info.png" alt="안내문"/>'}
		        dom += '<span class="chat_time">' + data.msgtime + '</span></p></div>';                
                break;
        }
		dom += '</p></div>';
        content.insertAdjacentHTML("beforeend", dom);        
    }
	
});

socket.on("trade_seller", function(data) {
    console.log("trade_seller", data);
	var dom = '<div class="bubble mach_speech"><p>';
    var content = document.getElementById("content");    
    
    if(data.type === "err") {
        dom += "<em>" + data.msg + "</em> 명령어는 판매자가 실행할 수 없습니다.";
        dom += '<span class="chat_time">' + data.msgtime + '</span></p></div>';    
        dom += '</p></div>';
        content.insertAdjacentHTML("beforeend", dom);
    } else if(data.type === "basic"){
        var tradePrice = document.getElementById("tradePrice").value;   
        var tradeStatus = document.getElementById("tradeStatus").value;

        if(data.flagNum === undefined) {
            switch (data.command) { // 구매자
                case 1:     
                    if(tradeStatus === "50") {
                        dom += '판매자의 거래요청을 기다리는 중입니다.<br>잠시만 기다려주세요.'; 
                    } else {    
                        return;  
                    }
                    break;
                case 1.1:
                    chatUI.setTradeInfo();
                    dom += '판매자가 <em>' + data.price + data.ccCode + '</em>의 가격으로 거래요청을 하였습니다.<br>거래를 진행하시려면 <em>@마하 구매확인</em>을 입력해주세요<span class="chat_time">' + data.msgtime + '</span>';
                    break;
                case 3:           
                    dom += '';   
                    break;
                case 5:           
                    dom += '';   
                    break;
                default:
                    dom += '';
                    break;
            }
        } else {
            switch (data.command) { // 판매자
                case 1:    
                    if(tradeStatus === "50" && socket.isTradeStep1 === undefined) {
                        dom += '거래를 시작하겠습니다.<br>먼저 거래 가격을 입력해주세요.<br><span class="chat_time">' + data.msgtime + '</span>';             
                        dom += '<input type="text" id="iptPrice" class="ipt_price" value="' + tradePrice + '"><button id="btnTransactionRequest" class="btn_chat btn_t_r">거래요청</button>';
                        socket.isTradeStep1 = true;
                    }else if(tradeStatus === "1") {
                        dom += '이미 거래요청 상태입니다.';             
                    } else if(socket.isTradeStep1 ){
                        dom += '거래 가격을 입력하고 거래요청을 눌러주세요.';
                    } else {

                    }
                    break;
                case 1.1:    
                    chatUI.setTradeInfo();       
                    dom += '거래요청이 정상적으로 완료되었습니다.<br>구매자의 구매확인을 기다리는 중입니다.';   
                    break;
                case 3:
                    dom += '';
                    break;
                case 5:           
                    dom += '';   
                    break;                    
                default:
                    dom += '';
                    break;
            }
        }

		dom += '</p></div>';
        content.insertAdjacentHTML("beforeend", dom);
    }
});

socket.on("trade_buyer", function(data) {
    console.log("trade_buyer", data);
	var dom = '<div class="bubble mach_speech"><p>';
    var content = document.getElementById("content"); 

    if(data.type === "err") {
        dom += "<em>" + data.msg + "</em> 명령어는 구매자가 실행할 수 없습니다.";
        dom += '<span class="chat_time">' + data.msgtime + '</span></p></div>';    
        dom += '</p></div>';
        content.insertAdjacentHTML("beforeend", dom);
    } else if(data.type === "basic"){
        if(data.flagNum === undefined) {
            switch (data.command) { // 판매자
                case 2:           
                    dom += '구매자의 구매확인을 기다리는 중입니다.<br>잠시만 기다려주세요.';     
                    break;
                case 4:           
                    dom += '';
                    break;
                default:
                    dom += '';
                    break;
            }
        } else {
            switch (data.command) { // 구매자
                case 2:        
                    dom += '물건을 잘 받으셨나요?<br>구매를 확정 하시려면 구매확인을 눌러주세요.<br>거래취소를 원하시면 거래취소를 눌러주세요.<span class="chat_time">' + data.msgtime + '</span>';
                    dom += '<button id="btnPurchaseConfirmation" class="btn_chat btn_p_c">구매확인</button>';    
                    dom += '<button id="btnCancelTransaction" class="btn_chat btn_">거래취소</button>';    
                    break;
                case 4:           
                    dom += '';
                    break;
                default:
                    dom += '';
                    break;
            }
        }
       
		dom += '</p></div>';
        content.insertAdjacentHTML("beforeend", dom); 
    }    
});

// 접속 끊겼을 때
socket.on('reconnect', function (data) {
    console.log('reconnect');
    socket.emit('joinroom', { room: _room, userId: _userId, reconnect: true });
});

var chatUI = {
    isDim: false,
    room: document.getElementById("room").value,
    country: document.getElementById("country").value,
    itemId: document.getElementById("itemId").value,
    init: function() {
        this.fnAt();
        this.orientationchange();
        this.sendMsg();
        this.ActBtn();
        this.setTradeInfo();
    },
    fnAt: function() {
        var that = this;

        function hideDim() {
            that.isDim = false;
            document.getElementById("atSec").style.display="none";
            document.getElementById("chatDim").style.display="none";  
        }

        function showDim() {
            that.isDim = true;
            document.getElementById("atSec").style.display="block";
            document.getElementById("chatDim").style.display="block";
        }
        
        document.getElementById("btnAt").addEventListener("click", function(){
            showDim();
        });

        document.getElementById("chatWrap").addEventListener("click", function(e){
            if(e.target.id === "chatDim" && that.isDim){
                hideDim();
            }
        });

        var machCmd = document.querySelectorAll(".at_sec .machCmd");
        var iptChat = document.getElementById("iptChat");
        for (var i = 0; i < machCmd.length; i++) {
            machCmd[i].addEventListener("click", function(e){
                //console.log(e.target.innerText);
                iptChat.value = "";
                iptChat.value = e.target.innerText;
                hideDim();
                // 여기서 메세지 입력되면 됨
                
                fnScrollLast(); // 스크롤 자동 최하단 이동
            });
        }
    },
    orientationchange: function() {
        window.addEventListener("orientationchange", function() {
            // window.orientation: 90 가로, 0 세로
            document.getElementById("content").addEventListener("click", function(){
                document.getElementById("chatDim").focus();
            });
        });        
    },
    sendMsg: function() {
        var iptChat = document.getElementById("iptChat");
        iptChat.addEventListener("keypress", function(ev){
            if (ev.which == 13) {
                if (ev.target.value==="") {
                    alert("메세지를 입력해주세요.");
                    return;
                }
                fnSendMsg();
            }
        });
        document.getElementById("btnSend").addEventListener("click", function(ev){
            if (ev.target.previousSibling.previousSibling.value==="") {
                alert("메세지를 입력해주세요.");
                return;
            }
            fnSendMsg();
        });
    },
    setTradeInfo: function() {
        var itemId = this.itemId;
        $.ajax({
            url: "http://13.209.227.60:3200/v2/items/" + itemId,
            headers: {"token": document.getElementById("tk").value},
            type: "GET",
            contentType: "application/json; charset=utf-8",
        })
        .done(function(result) {
            var item = result.data;
            console.log(item);
            document.getElementById("tradePrice").value = item.price;
            document.getElementById("tradeStatus").value = item.status;
            document.getElementById("vtrPriceNum").innerText = item.price;
            
            switch (item.category) {
                case "etc":
                    document.getElementById("vtrategory").innerText = "자산거래";
                    break;
                case "game":
                    document.getElementById("vtrategory").innerText = "게임아이템";
                    break;
                case "otc":
                    document.getElementById("vtrategory").innerText = "OTC거래";
                    break;
            }
        })
        .fail(function(xhr, status, error) {
            console.log("채팅방 정보를 가져오는 중에 에러 발생", error);
        });
    },
    ActBtn: function() {
        var that = this;
        var buyerTag = document.getElementById("buyerTag").value;
        var sellerTag = document.getElementById("sellerTag").value;
        var dom = '<div class="bubble mach_speech"><p>';
        var content = document.getElementById("content");
        var itemId = this.itemId;
        var proxyEvent= {
            "btnTransactionRequest": function() {
                var thisDom = this;
                var tradePrice = parseFloat(document.getElementById("iptPrice").value);
                var ccCode = "MACH";
                if(tradePrice === 0 || isNaN(tradePrice)) {
                    alert("가격을 입력해주세요.");
                    return;
                }

                var bodyParam = {};
                bodyParam.itemId = itemId;
                bodyParam.stepValue = "1";
                bodyParam.reqValue = {
            		buyerTag: buyerTag,
                    sellerTag: sellerTag,
                    cryptoCurrencyCode: ccCode,
                    price: tradePrice,
                    //country: that.country,
                };

                $.ajax({
                    url: "/test/call-backend",
                    data: JSON.stringify(bodyParam),
                    type: "POST",
                    contentType: "application/json; charset=utf-8",
                    dataType: "json"
                })
                .done(function(json) {
                    console.log(json);

                    thisDom.setAttribute("disabled", "disabled");
                    socket.emit("trade", { who: _userId, to: othername.value, command: 1.1, price: tradePrice, ccCode:ccCode, buyerTag: buyerTag, sellerTag: sellerTag });
                })
                .fail(function(xhr, status, error) {
                    console.log(error);
                    alert("구매 요청 중 에러가 발생하였습니다.");
                })                
            },        
            "btnPurchaseConfirmation": function() {
                var thisDom = this;

                var bodyParam = {};
                bodyParam.itemId = itemId;
                bodyParam.stepValue = "2";

                $.ajax({
                    url: "/test/call-backend",
                    data: JSON.stringify(bodyParam),
                    type: "POST",
                    contentType: "application/json; charset=utf-8",
                    dataType: "json"
                })
                .done(function(json) {
                    console.log(json);
                    if(json.successYn === undefined) {
                        thisDom.setAttribute("disabled", "disabled");
                        alert("구매 확인");
                    } else {
                        alert(json.msg);
                    }

                })
                .fail(function(xhr, status, error) {
                    console.log(error);
                    alert("구매 확인 중 에러가 발생하였습니다.");
                });
            },
            "btnSalesComplete": function() {
                alert("판매 확인");
            },
            "btnTransactionComplete": function() {
                alert("거래 완료");
            },
            "btnCancelTransaction": function() {
                var thisDom = this;

                var bodyParam = {};
                bodyParam.itemId = itemId;
                bodyParam.stepValue = "5";

                $.ajax({
                    url: "/test/call-backend",
                    data: JSON.stringify(bodyParam),
                    type: "POST",
                    contentType: "application/json; charset=utf-8",
                    dataType: "json"
                })
                .done(function(json) {
                    if(json.successYn === undefined) {
                        thisDom.setAttribute("disabled", "disabled");
                        alert("거래 취소");
                    } else {
                        alert(json.msg);
                    }

                })
                .fail(function(xhr, status, error) {
                    console.log(error);
                    alert("거래 취소 중 에러가 발생하였습니다.");
                });
            },
        };

        document.addEventListener("click", function(e) {
            var target = e.target || e.srcElement;
            if(proxyEvent.hasOwnProperty(target.id)) {
                proxyEvent[target.id].call(target);
            }
        });  
    }
}    
chatUI.init();

function getChatInDB() {
    $.ajax({
        url: "http://localhost:4000/vtr/getchat",
        data: {},
        type: "GET",
        dataType: "json"
    })
    .done(function(json) {
        console.log(json[0].msgs);
    })
    .fail(function(xhr, status, errorThrown) {

    })
}
</script>    
</body>
</html>